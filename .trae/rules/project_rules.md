加载env必须用packages/server/src/trans_hub/bootstrap/init.py
#### **1. 核心架构原则**

1.1. **单一职责 (SRP)**: 每个模块、类、函数**必须**只做一件事。
1.2. **依赖倒置 (DIP)**: 核心业务逻辑**必须**依赖于**抽象 (`typing.Protocol`)**，而不是具体的实现。
1.3. **单向依赖与包结构**: **必须**遵循严格的**单向依赖**层次结构。高层模块（如 CLI）可以依赖低层模块（如 Coordinator），但低层模块**严禁**导入高层模块。
1.4. **无副作用导入**: **严禁**在模块的顶层（即导入时）执行有副作用的操作（如网络请求、文件 I/O、日志输出）。所有初始化逻辑**必须**由明确的函数调用（如 `Coordinator.initialize`, `cli.main`）触发。
1.5. **服务层抽象**: 高层模块（如 `Coordinator`、CLI 命令）**必须**通过定义好的服务层接口进行交互，**严禁**直接执行复杂的、包含多步业务逻辑的数据查询或操作。
1.6. **配置与实现分离**: 核心配置模块（如 `config.py`）**必须**只负责定义和加载配置的“形状”和原始数据，**严禁**静态导入任何具体的业务实现模块（如引擎模块）。业务实现的配置**必须**通过“自注册”和“动态解析”的方式在运行时加载。
1.7. **可选依赖隔离原则**: 任何实现可选功能（extras）的模块，**严禁**在模块的顶层直接导入其可选依赖库。所有可选依赖的导入**必须**通过以下两种方式之一进行处理：
_ 在 `if TYPE_CHECKING:` 块中进行类型提示导入，并在实际使用该库的函数或方法内部进行运行时导入。
_ 在模块顶层使用 `try...except ImportError:` 块进行安全导入。
1.8. **【新增】Sync/Async 边界隔离原则**: **必须**清晰地隔离同步和异步代码的执行上下文。
_ **管理任务 vs. 应用运行时**: 用于项目管理和部署的工具（如 Alembic 迁移）**应该**作为纯同步进程运行。应用的核心运行时（如 Worker、API 服务）**应该**作为纯异步进程运行。
_ **严禁**在一个已在运行的 `asyncio` 事件循环中，尝试创建并运行一个新的事件循环（例如，通过 `asyncio.run()`）。 \* 当同步代码需要调用异步功能时，**必须**使用经过验证的桥接技术（如 `greenlet`），并确保其上下文被正确设置。

#### **2. 数据、配置与业务规则**

2.1. **唯一真实来源 (SSOT)**:
_ **(a) 配置**: 所有配置项的定义**必须**集中在 `trans_hub/config.py` 中。
_ **(b) 【新增】数据模型**: 所有数据库表的结构定义，其**唯一真实来源必须是 `trans_hub/db/schema.py`** 中的 SQLAlchemy 声明式模型。**严禁**保留任何手写的 `.sql` Schema 文件。
2.2. **数据容器**: **必须**使用 `pydantic` 作为核心数据类库，以确保运行时的数据验证和清晰的 schema 定义。
2.3. **【新增】数据库驱动明确化**: 在数据库连接 URL 中，**必须**明确指定要使用的异步驱动程序（例如，`postgresql+asyncpg://` 或 `sqlite+aiosqlite://`），以消除 SQLAlchemy 在选择驱动时的不确定性。
2.4. **稳定引用原则**: 系统**必须**区分内部主键（如 UUID）和对外暴露的**稳定业务引用 ID**（如 `business_id`）。所有外部系统或 API 调用**必须**使用稳定引用 ID 来定位内容，**严禁**暴露或依赖内部主键。
2.5. **结构化载荷优先**: 对于核心内容（原文、译文），**必须**优先使用结构化的数据格式（如 **JSON**）进行存储（`payload` 字段），即使当前内容只是简单文本。

#### **3. 数据库实践**

3.1. **数据库演进**: **必须**使用 **Alembic** 管理所有数据库 Schema 的变更。在 `v3.0.0` 发布后，任何 Schema 变更**必须**通过创建**新的、独立的、带版本号的迁移脚本**来实现，**严禁**修改已发布的迁移脚本。
3.2. **【新增】显式主键生成**: 对于所有使用原生 SQL（如通过 `asyncpg`）执行的 `INSERT` 操作，**必须**在应用层显式生成并提供主键（如 UUID）的值，**严禁**依赖数据库的隐式 `server_default` 行为。
3.3. **日期与时间戳比较**: **必须**明确区分日期（Date）和时间戳（Timestamp）的比较逻辑。对于基于“天”的保留策略（如垃圾回收），SQL 查询**必须**使用日期函数（如 `DATE(...)`）对时间戳字段进行转换，以避免因时间部分导致的错误比较。

#### **4. 测试体系**

4.0. **测试驱动修复 (TDF) 原则**:

> 这是一个**元原则 (Meta-Principle)**，其优先级高于所有其他测试规则。
>
> - **(a) 缺陷复现**: 对于在主程序中发现的任何一个 Bug 或缺陷，**必须**首先编写一个或多个**能够稳定复现该缺陷的测试用例**。这个测试用例在修复前**必须是失败的 (`FAILED`)**。
> - **(b) 测试驱动修复**: 随后，对主程序的所有修改，其**唯一目标**就是使这个（或这些）新添加的测试用例**变为通过 (`PASSED`)**，同时确保没有破坏任何现有的测试。
> - **(c) 【新增】重构验证**: 在完成一次重构后，**必须**运行**完整的**测试套件（`poetry run pytest`），以确保没有引入任何回归错误。

4.1. **测试覆盖**: 所有功能与 Bug 修复**必须**有对应的测试。
4.2. **测试分层**: **必须**建立“`tests/unit` + `tests/integration`”的物理分层结构。
_ **单元测试**: 必须快速、隔离，严禁执行任何网络或文件 I/O。
_ **集成测试**: 可以执行文件 I/O、数据库操作，验证多个组件的协同工作。
4.3. **测试原则**:
_ 测试应基于**行为（输入输出）**，而非内部实现细节。
_ 单元测试**必须**是**确定性的**，**严禁**依赖物理时间（如 `time.sleep`），应使用 `pytest-mock` 或 `asyncio` 的工具来控制时间。
_ **异常消息断言**: **必须**优先使用**子字符串包含断言**（`assert '...' in str(exc_info.value)`），而不是精确的正则表达式匹配 (`match=...`)。
4.4. **【新增】测试环境依赖声明**:
_ 任何仅在测试代码中被 `import` 的库（例如 `rich`, `typer`, `questionary`），**必须**被明确地添加到 `pyproject.toml` 的 `[tool.poetry.group.dev.dependencies]` 组中。 \* 用于支持特定数据库后端测试的驱动（例如 `asyncpg`, `psycopg2-binary`），也**必须**被添加到 `dev` 依赖组中。

#### **5. 依赖、安全与 CI/CD**

5.1. **依赖管理**:
_ **必须**使用 Poetry 的**依赖组 (Dependency Groups)**（如 `[tool.poetry.group.dev.dependencies]`）来严格分离核心依赖、可选依赖、开发依赖和文档依赖。
_ **核心依赖 (`[dependencies]`)**: **必须**包含应用在生产环境中**运行和部署**所需的所有包，包括 `alembic` 和 `sqlalchemy`。
_ **开发依赖 (`[group.dev.dependencies]`)**: **必须**包含所有仅用于**本地开发、测试和静态分析**的包。
_ **必须**确保 `pyproject.toml` 中的 `python` 版本约束、`classifiers` 以及所有静态分析工具（`ruff`, `mypy`）的目标版本声明**完全一致**。
5.2. **依赖最小化**: 核心库的依赖**必须**保持最小化，新功能应优先通过 `extras` 实现。
5.3. **凭证安全**: **严禁**在代码库中提交任何明文密钥。所有凭证**必须**通过环境变量或安全的密钥管理服务进行管理。
5.4. **CI 门禁**: 所有代码合并前，**必须**通过 CI 流水线中定义的所有检查。

#### **6. 项目特定约定**

6.1. **【新增】示例代码与文档同步**:
_ 在完成重大重构（如数据库迁移系统变更）后，**必须**审查并更新 `examples/` 目录下的所有脚本，确保它们能够正常运行并反映最新的 API 用法。
_ **必须**在示例脚本的文档或注释中，提供清晰的、最新的运行指南，包括任何必需的环境准备步骤（如 `poetry run alembic upgrade head`）。
