#### **1. 架构与设计**

1.1. **单一职责 (SRP)**: 每个模块、类、函数**必须**只做一件事。
1.2. **依赖倒置 (DIP)**: 核心业务逻辑**必须**依赖于**抽象 (`typing.Protocol`)**，而非具体实现。
1.3. **单向依赖**: **必须**遵循严格的**单向依赖**层次结构。**严禁**通过任何技巧“修复”循环导入，而应从根本上重构以消除它们。
1.4. **能力声明**: 组件的能力**必须**通过明确的**类属性** (如 `ACCEPTS_CONTEXT: bool`) 进行声明，而非运行时 (`hasattr`) 判断。

#### **2. 数据与配置**

2.1. **数据容器**: 对于需运行时验证的**外部数据**（如配置文件），**必须**使用 `pydantic_settings.BaseSettings`；对于纯粹的**内部DTOs**，**推荐**使用 `@dataclasses.dataclass(frozen=True)`。
2.2. **配置加载**:
    *   所有配置项**必须**集中在 `config.py` 中定义。
    *   所有 `BaseSettings` 模型**不应**在其 `model_config` 中硬编码 `env_file`，以保证 CI 优先原则。
2.3. **数据库主键**: 持久化实体的主键**必须**是全局唯一的。**推荐**使用 **UUID**，也可接受外部系统的全局唯一自然键。
2.4. **数据库约束**: 记录状态的关联表（如 `th_translations`）**必须**使用 `UNIQUE` 复合约束来从数据库层面保证业务逻辑的唯一性。
2.5. **数据库演进**: 任何 Schema 变更**必须**通过创建**新的、独立的、带版本号的迁移脚本**来实现。

#### **3. 编码实践**

3.1. **纯粹异步**: 核心库**必须**是**纯异步**的。任何阻塞式 I/O **必须**通过 `asyncio.to_thread` 包装。
3.2. **并发安全**: 所有跨越 `await` 的数据库写操作或事务，**必须**被 `asyncio.Lock` 或等价机制保护。
3.3. **惰性加载**: 对于可能在**导入时**产生副作用（特别是网络 I/O）的第三方库，其 `import` 语句**必须**被推迟到真正需要它的函数或方法内部执行。
3.4. **错误处理**: 所有可预见的错误**必须**使用 `trans_hub/exceptions.py` 中定义的语义化自定义异常。

#### **4. 测试体系**

4.1. **测试覆盖**: 所有功能与 Bug 修复**必须**有对应的单元测试或集成测试。
4.2. **测试分层**: **必须**建立“单元测试 + 端到端测试”的分层体系，明确各自职责。
4.3. **测试原则**: 测试应基于**行为（输入输出）**，避免依赖内部实现细节。
4.4. **Mocking 规范**:
    *   **必须**为 `async def` 目标使用 `AsyncMock`，为同步函数使用 `MagicMock`。
    *   创建时**必须**使用 `spec=True` 或 `autospec=True` 来确保接口一致性。
    *   **必须**确保模拟对象的结构和行为与真实对象完全一致，以同时满足 `pytest` 运行时和 `mypy` 静态检查。
    *   仅在无法通过结构化模拟解决 `mypy` 问题时，才**允许**使用 `# type: ignore`，且**必须**附带注释说明原因。
4.5. **Fixture 规范**: 对于使用 `yield` 的 pytest Fixture，其返回类型注解**必须**写明为 `typing.Generator[...]`。

#### **5. 依赖、安全与 CI/CD**

5.1. **依赖最小化**: 核心库的依赖**必须**保持最小化，新功能应优先通过 `extras` 实现可选扩展。
5.2. **凭证安全**: **严禁**在代码库中提交任何明文密钥、密码、令牌等敏感信息。
5.3. **CI 门禁**: 所有代码合并前，**必须**通过 CI 流水线中定义的所有检查（格式化、静态分析、类型检查、测试）。