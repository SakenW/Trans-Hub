> 以下是 `Trans-Hub` 项目本身的技术规范和架构约束，**必须**全部遵守。

#### **1. 架构与设计**

1.1. **单一职责 (SRP)**: 每个模块、类、函数**必须**只做一件事。
1.2. **依赖倒置 (DIP)**: 核心业务逻辑**必须**依赖于**抽象 (`typing.Protocol`)**。
1.3. **单向依赖与包结构**:
    *   **必须**遵循严格的**单向依赖**层次结构。**严禁**通过任何技巧“修复”循环导入，而应从根本上重构以消除它们。
    *   **新增**: 所有包含 Python 源码的目录**必须**包含一个 `__init__.py` 文件，以被视为一个正规的“包”，确保静态分析工具的可靠性。
    *   **新增**: 当一个模块的功能未来有明确的扩展可能时（如 `policies`），应**优先**将其设计为包结构（即一个带 `__init__.py` 的目录），即使当前只有一个实现。
1.4. **能力声明**: 组件的能力**必须**通过明确的**类属性**进行声明。

#### **2. 数据与配置**

2.1. **数据容器**: **必须**使用 `pydantic` 及其生态（如 `pydantic-settings`）。
2.2. **配置加载**: 配置**必须**集中且与环境无关。
2.3. **数据库主键**: 主键**必须**是全局唯一的。
2.4. **数据库约束**:
    *   **修正**: 记录状态的关联表（如 `th_jobs`, `th_translations`）**必须**使用能正确处理 `NULL` 值的唯一性约束来保证业务逻辑。**严禁**使用在 `NULL` 值上行为不确定的标准 `UNIQUE` 复合约束。
    *   **推荐**: 使用**部分唯一索引 (Partial Unique Indexes)**，例如 `CREATE UNIQUE INDEX ... WHERE context_id IS NULL`。
2.5. **数据库演进**:
    *   任何 Schema 变更**必须**通过创建**新的、独立的、带版本号的迁移脚本**来实现。
    *   **补充**: 在 `v1.0.0` 正式发布前（即 `dev` 或 `alpha` 阶段），允许直接修改初始迁移脚本 (`001_...`) 以完善基础 Schema。

#### **3. 编码实践**

3.1. **纯粹异步**: 核心库**必须**是**纯异步**的。任何阻塞式 I/O **必须**通过 `asyncio.to_thread` 包装。
3.2. **并发安全**:
    *   **修正**: 所有跨越多条语句的数据库写操作，**必须**被数据库层面的**事务 (BEGIN...COMMIT)** 保护。**严禁**在应用层使用全局锁（如 `asyncio.Lock`）来模拟事务。
3.3. **惰性加载**:
    *   对于可能在**导入时**产生副作用（特别是网络 I/O 或配置校验）的类，其**实例化**操作应被推迟到真正需要它的函数或方法内部执行。
    *   `Coordinator.__init__` **不应**预先实例化所有引擎，而应在首次请求该引擎时进行**惰性实例化**。
3.4. **错误处理**: 所有可预见的错误**必须**使用 `trans_hub/exceptions.py` 中定义的语义化自定义异常。
3.5. **SQL 语法**:
    *   所有 `.sql` 文件中的注释**必须**使用 `--`，严禁使用 `#` 或其他非标准注释。

#### **4. 测试体系**

4.1. **测试覆盖**: 所有功能与 Bug 修复**必须**有对应的测试。
4.2. **测试分层**: **必须**建立“单元测试 + 端到端测试”的分层体系。
4.3. **测试原则**:
    *   测试应基于**行为（输入输出）**，避免依赖内部实现细节。
    *   **新增**: 单元测试**必须**是**确定性的 (deterministic)**。**严禁**依赖物理时间（如 `asyncio.sleep`）来处理竞态条件。**必须**使用 `mock` 来精确控制时间、网络请求等不确定性因素。
    *   **新增**: 异步和并发逻辑的测试，**必须**包含对**竞态条件和资源生命周期**（如优雅停机）的显式验证。
4.4. **Mocking 规范**:
    *   **必须**为 `async def` 目标使用 `AsyncMock`，为同步函数使用 `MagicMock`。
    *   创建时**必须**使用 `spec=True` 或 `autospec=True` 来确保接口一致性。
    *   **修正**: 模拟复杂对象（如 Pydantic 模型）的实例时，**必须**精确地模拟其**完整的、嵌套的属性结构**，以避免在测试中出现意外的 `AttributeError`。
4.5. **Fixture 规范**: **必须**为 `pytest` Fixture 提供准确的返回类型注解，对于使用 `yield` 的 Fixture，**必须**写明为 `typing.Generator[...]`。

#### **5. 依赖、安全与 CI/CD**

5.1. **依赖最小化**: 核心库的依赖**必须**保持最小化，新功能应优先通过 `extras` 实现可选扩展。
5.2. **凭证安全**: **严禁**在代码库中提交任何明文密钥、密码、令牌等敏感信息。
5.3. **CI 门禁**: 所有代码合并前，**必须**通过 CI 流水线中定义的所有检查（格式化、静态分析、类型检查、测试）。
