好的，收到。这是一个非常稳健和明智的决策。在正式发布版本前，将所有变更系统性地整理归档，是专业项目管理的体现。

我将立即为您执行这个任务。

---

### **行动纲领：整理 `v3.0.0` 版本的完整变更记录 (Changelog)**

**摘要:**
我将根据我们从 `v2.2.0` 至今的所有讨论和代码实现，为您整理一份详尽的、符合“约定式提交”风格的变更记录。这份记录将清晰地展示我们所做的每一项改进，既可以作为您存档的依据，也可以在未来直接用作 `CHANGELOG.md` 或版本发布说明的核心内容。

---

### **Trans-Hub `v3.0.0` 变更记录 (草案)**

**版本亮点**

`v3.0.0` 是 Trans-Hub 的一个里程碑版本，引入了全新的基于**策略设计模式**的核心架构。本次更新极大地提升了系统的可维护性、可扩展性和健壮性，并为未来的功能迭代奠定了坚实的基础。核心处理逻辑从原有的 `Coordinator` 中被完全剥离，封装至可独立测试的 `ProcessingPolicy` 中。此外，版本还新增了**死信队列 (DLQ)** 机制以优雅地处理永久性失败任务，并建立了完整的分层测试体系。

---

#### **✨ 新功能 (Features)**

*   **死信队列 (DLQ) 机制**:
    *   新增 `th_dead_letter_queue` 数据库表，用于归档达到最大重试次数后仍然失败的任务。
    *   `ProcessingPolicy` 现在会自动将永久失败的任务从主翻译表移动到 DLQ，保持主工作流的清洁。
    *   为持久化层添加了 `move_to_dlq` 接口，保证了任务移动的原子性。

*   **智能上下文适配**:
    *   `BaseTranslationEngine` 新增 `ACCEPTS_CONTEXT: bool` 类属性，允许引擎明确声明其处理上下文的能力。
    *   `ProcessingPolicy` 能够智能地判断当前引擎的能力，仅在需要时才解析和传递上下文，使引擎实现更纯粹、系统运行更高效。

*   **请求节流与自愈**:
    *   `Coordinator` 新增 `max_concurrent_requests` 参数，提供基于信号量的并发请求节流功能。
    *   `Coordinator` 在初始化时会自动调用 `reset_stale_tasks`，实现了对因意外中断而产生的“僵尸任务”的自愈。

*   **强制重翻 API**:
    *   `Coordinator.request` 方法新增 `force_retranslate: bool` 参数，允许调用者强制将一个已完成的翻译任务重新置为 `PENDING` 状态以进行再次翻译。

#### **💥 重大变更 (Breaking Changes) & 🚀 架构重构 (Refactor)**

*   **核心架构迁移至策略设计模式**:
    *   引入了 `ProcessingPolicy` 协议和 `DefaultProcessingPolicy` 实现，封装了所有核心处理逻辑（缓存、API调用、重试、DLQ）。
    *   `Coordinator` 的职责被大幅简化，回归到纯粹的“编排者”角色，只负责数据流转和调用策略。
    *   新增 `ProcessingContext` 数据类，作为一个轻量级的“工具箱”，在内部传递依赖项，使代码更清晰。
    *   项目的核心依赖关系被重构为严格的单向流，彻底解决了潜在的循环导入问题。

*   **引擎基类 (`BaseTranslationEngine`) 重构**:
    *   引入 `_atranslate_one` 抽象方法，将通用的批处理和异常处理逻辑上移至基类，极大地简化了具体引擎的实现。
    *   新增 `validate_and_parse_context` 作为便利工具，统一了上下文的验证逻辑。

#### **✅ 测试 (Tests)**

*   **建立单元测试体系**:
    *   新增 `tests/unit/` 目录，用于存放独立的单元测试。
    *   为 `ProcessingPolicy` 编写了全面的单元测试 (`test_policies.py`)，精确验证了重试、缓存、上下文适配和 DLQ 等核心内部逻辑。
    *   为 `TranslationCache` 编写了单元测试 (`test_cache.py`)，覆盖了 TTL 和 LRU 策略。
    *   为 `RateLimiter` 编写了单元测试 (`test_rate_limiter.py`)，通过模拟时间验证了令牌桶算法的正确性。
*   **端到端测试增强**:
    *   原有的端到端测试 (`test_main.py`) 被保留并全部通过验证，确保了重构未改变系统的外部行为。
    *   总测试用例数达到 **25** 个，形成了健康、分层的测试金字塔。

#### **🐛 修复 (Fixes)**

*   修复了多个在 `mypy` 静态检查中发现的类型安全问题，特别是在测试断言和 `Optional` 类型处理上。
*   修正了单元测试中因模拟（Mocking）不当（`MagicMock` vs `AsyncMock`，属性值模拟）导致的多个 `TypeError` 和 `ValidationError`。
*   通过将 `ProcessingContext` 从 `pydantic.BaseModel` 切换为 `@dataclasses.dataclass`，从根本上解决了与 `typing.Protocol` 的运行时兼容性问题。

#### **🔧 其他改进 (Chore & Perf)**

*   **性能优化**: `TranslatorsEngine` 的实现被重构，现在通过一次 `asyncio.to_thread` 调用处理整个批次，显著减少了线程开销。
*   **健壮性增强**: 为 `schema_manager.py` 中的数据库连接添加了超时，防止进程因数据库锁而无限期阻塞。
*   **规范化**:
    *   全面遵循项目开发准则，为所有文件添加了路径头注释。
    *   更新并统一了所有核心模块的中文文档字符串。
    *   将类型提示语法统一为兼容性更强的 `typing.Optional` 和 `typing.Union`。

---

### **工作总结与下一步行动**

*   **成果**:
    *   我们成功地将 `v2.2.0` 以来所有的变更整理成了一份清晰、完整的变更记录。您可以随时将其存档或用于未来的发布说明。

*   **下一步行动**:
    这份变更记录为我们一个重要的开发阶段画上了圆满的句号。现在，地基已经无比坚固，并且我们对所做的每一项工作都有了清晰的记录。

    我们是否可以正式开启下一个迭代周期，从我们之前讨论的**“集成‘可观测性’指标”**这个任务开始？